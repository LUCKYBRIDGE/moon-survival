<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ ì¡°ë‚œ ìƒí™© ìƒì¡´ ì‹œë®¬ë ˆì´ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!--
        Copyright (c) 2025 [Pinky]
        This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
        You should have received a copy of the license along with this work. If not, see <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
    -->
    <!-- Chosen Palette: Cosmic Harmony (Deep Blue, Slate Gray, Muted Orange, Cream) -->
    <!-- Application Structure Plan: A linear, multi-stage single-page application. The flow is: 1. Intro -> 2. Role Selection -> 3. Knowledge Briefing -> 4. Main Ranking Activity -> 5. Final Report & Save. This step-by-step structure is chosen for its simplicity and clarity, making it easy for 5th-grade students to follow without getting overwhelmed. It guides them through a narrative journey, enhancing engagement and ensuring they complete each cognitive step (understanding the scenario, adopting a role, processing information, making decisions) before moving to the next. -->
    <!-- Visualization & Content Choices: 
        - Scenario/Roles/Knowledge: Presented as clear, static text on distinct screens to avoid cognitive overload. Roles are visualized with large, friendly Unicode icons on clickable cards for intuitive selection. Knowledge is updated with user-provided content and is viewable on demand via a modal.
        - 15 Survival Items: Displayed as interactive cards in a "pool". Each card is draggable and clickable. Clicking opens a modal with a very simple, neutral description. The info button remains visible even after ranking. When returned to the pool, the item reverts to its original state.
        - Priority Ranking: A drag-and-drop list powered by SortableJS provides a tangible, kinesthetic way to rank items. The guiding hint text has been removed as per user request.
        - Justification: A simple text input appears next to each ranked item, directly linking the action (ranking) to the reason.
        - Final Report: A static, read-only summary of the student's choices, which can be saved as an image with a custom filename based on group and student name.
        - Library/Method: Vanilla JS for state and navigation, SortableJS for interaction, html2canvas for output.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        html, body {
            overscroll-behavior: none;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0a192f; /* Deep Navy Blue */
            color: #e6f1ff;
        }
        .screen { display: none; }
        .active-screen { display: block; }
        .item-card {
            touch-action: none; /* Recommended for SortableJS */
        }
        .drag-handle {
            cursor: grab;
            padding: 0.5rem;
            color: #94a3b8; /* slate-400 */
        }
        .drag-handle:hover {
            color: #e2e8f0; /* slate-200 */
        }
        .sortable-ghost {
            background: #4a5568;
            opacity: 0.5;
        }
        .modal-base {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 2rem;
            width: 95%;
            max-width: 500px;
        }
    </style>
</head>
<body class="w-full min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="app-container" class="w-full max-w-7xl mx-auto bg-[#172a46] bg-opacity-80 backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8">

        <!-- Screen 1: Intro -->
        <div id="intro-screen" class="screen active-screen text-center">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-4">ë‹¬ì—ì„œ ê¸¸ì„ ìƒë‹¤</h1>
            <p class="text-base sm:text-lg md:text-xl text-slate-300 mb-6 max-w-2xl mx-auto">
                ë‹¹ì‹ ì´ íƒ„ ìš°ì£¼ì„ ì´ ë‹¬ì— ë¶ˆì‹œì°©í–ˆìŠµë‹ˆë‹¤.<br>
                ì‚´ì•„ë‚¨ê¸° ìœ„í•´, 200km ë–¨ì–´ì§„ êµ¬ì¡°ì„ ê¹Œì§€ ê°€ì•¼ í•©ë‹ˆë‹¤.<br>
                ì£¼ì–´ì§„ 15ê°œ ë¬¼í’ˆì˜ ìƒì¡´ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ê³ , ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”!
            </p>
            <div class="max-w-sm mx-auto mb-8 space-y-4">
                <div>
                    <label for="groupNameInput" class="block mb-2 text-sm font-medium text-slate-300">ëª¨ë‘ ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                    <input type="text" id="groupNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) 1ëª¨ë‘ " required>
                </div>
                <div>
                    <label for="studentNumberInput" class="block mb-2 text-sm font-medium text-slate-300">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
                    <select id="studentNumberInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" required>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="studentNameInput" class="block mb-2 text-sm font-medium text-slate-300">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</label>
                    <input type="text" id="studentNameInput" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5" placeholder="ì˜ˆ) í™ê¸¸ë™" required>
                </div>
            </div>
            <button id="start-mission-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-6 sm:px-8 rounded-lg transition-transform transform hover:scale-105">
                ë¯¸ì…˜ ì‹œì‘
            </button>
            <p class="text-xs text-slate-500 mt-8">made by.í•‘í‚¤ë„¤</p>
        </div>

        <!-- Screen 2: Role Selection -->
        <div id="role-screen" class="screen">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6">ë‹¹ì‹ ì˜ ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <p class="text-center text-slate-300 mb-8">ì„ íƒí•œ ì—­í• ì— ë”°ë¼ íŠ¹ë³„í•œ ì „ë¬¸ ì§€ì‹ì„ ì–»ê²Œ ë©ë‹ˆë‹¤.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                <div data-role="scientist" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                    <div class="text-5xl sm:text-6xl mb-4">ğŸ”¬</div>
                    <h3 class="text-xl sm:text-2xl font-bold">ìš°ì£¼ê³¼í•™ì</h3>
                    <p class="text-slate-400 text-sm sm:text-base">ë‹¬ì˜ í™˜ê²½ê³¼ ë¬¼ë¦¬ ë²•ì¹™ì— ëŒ€í•´ ê¹Šì´ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div data-role="explorer" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                    <div class="text-5xl sm:text-6xl mb-4">ğŸ§­</div>
                    <h3 class="text-xl sm:text-2xl font-bold">íƒí—˜ê°€</h3>
                    <p class="text-slate-400 text-sm sm:text-base">í—˜ë‚œí•œ ì§€í˜•ì„ ëŒíŒŒí•˜ê³  ê¸¸ì„ ì°¾ëŠ” ë° ëŠ¥ìˆ™í•©ë‹ˆë‹¤.</p>
                </div>
                <div data-role="communicator" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                    <div class="text-5xl sm:text-6xl mb-4">ğŸ“¡</div>
                    <h3 class="text-xl sm:text-2xl font-bold">í†µì‹ ì „ë¬¸ê°€</h3>
                    <p class="text-slate-400 text-sm sm:text-base">ì¥ë¹„ë¥¼ í™œìš©í•´ êµ¬ì¡° ì‹ í˜¸ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div data-role="medic" class="role-card bg-slate-700 p-4 sm:p-6 rounded-lg text-center cursor-pointer hover:bg-slate-600 hover:scale-105 transition-all">
                    <div class="text-5xl sm:text-6xl mb-4">ğŸ©º</div>
                    <h3 class="text-xl sm:text-2xl font-bold">ì˜ë£Œì§„</h3>
                    <p class="text-slate-400 text-sm sm:text-base">ê·¹í•œ ìƒí™©ì—ì„œ ìƒëª…ì„ ìœ ì§€í•˜ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
        
        <!-- Screen 3: Knowledge Briefing -->
        <div id="knowledge-screen" class="screen">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-2">ì „ë¬¸ ì§€ì‹ ë¸Œë¦¬í•‘</h2>
            <p id="role-title" class="text-center text-orange-400 font-bold text-lg mb-6"></p>
            <div id="knowledge-list" class="bg-slate-800 p-4 sm:p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4 text-slate-300 max-h-[60vh] overflow-y-auto">
                <!-- Knowledge items will be injected here by JS -->
            </div>
            <div class="text-center mt-8">
                 <button id="go-to-ranking-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ë¬¼í’ˆ ìˆœìœ„ ì •í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- Screen 4: Main Ranking Activity -->
        <div id="main-screen" class="screen">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl sm:text-3xl font-bold text-center flex-grow">ìƒì¡´ ë¬¼í’ˆ ìš°ì„ ìˆœìœ„ ì •í•˜ê¸°</h2>
                <button id="open-knowledge-modal-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex-shrink-0 w-full sm:w-auto">
                    ë‚´ ì „ë¬¸ì§€ì‹ ë³´ê¸° ğŸ§ 
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Left: Item Pool -->
                <div class="w-full md:w-1/3">
                    <h3 class="font-bold text-xl mb-4 text-center">ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¼í’ˆ</h3>
                    <div id="items-pool" class="bg-slate-800 p-4 rounded-lg min-h-[300px] md:min-h-[60vh] grid grid-cols-1 gap-3 overflow-y-auto">
                        <!-- Item cards will be injected here by JS -->
                    </div>
                </div>
                <!-- Right: Ranking List -->
                <div class="w-full md:w-2/3">
                    <h3 class="font-bold text-xl mb-4 text-center">ë‚˜ì˜ ìƒì¡´ í‚¤íŠ¸ ìˆœìœ„</h3>
                    <div id="rank-list" class="bg-slate-800 p-4 rounded-lg min-h-[300px] md:min-h-[60vh] space-y-3 overflow-y-auto">
                       <!-- Ranked items will be dropped here -->
                    </div>
                </div>
            </div>
             <div class="text-center mt-8">
                 <button id="finish-button" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                    ê²°ê³¼ ë³´ê³ ì„œ ë§Œë“¤ê¸°
                </button>
            </div>
        </div>
        
        <!-- Screen 5: Final Report -->
        <div id="report-screen" class="screen">
             <div id="report-content" class="p-2">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-4">ë‚˜ì˜ ìµœì¢… ìƒì¡´ ì „ëµ</h2>
                <p class="text-center text-slate-300 mb-8">
                    ëª¨ë‘ : <span id="final-group-name" class="font-bold text-cyan-400"></span> / 
                    <span id="final-student-number" class="font-bold text-cyan-400"></span>ë²ˆ 
                    <span id="final-student-name" class="font-bold text-cyan-400"></span> / 
                    ì „ë¬¸ ë¶„ì•¼: <span id="final-role" class="font-bold text-orange-400"></span>
                </p>
                <div id="final-list" class="space-y-3 bg-slate-800 p-4 sm:p-6 rounded-lg">
                    <!-- Final report will be generated here -->
                </div>
            </div>
            <div class="text-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="download-report-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ê²°ê³¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°
                </button>
                 <button id="restart-btn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold text-lg sm:text-xl py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
                    ë‹¤ì‹œí•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <!-- Item Modal -->
    <div id="item-modal" class="modal-base hidden">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span id="close-item-modal-btn" class="absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="modal-body" class="text-white">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Knowledge Modal -->
    <div id="knowledge-modal" class="modal-base hidden">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600">
            <span id="close-knowledge-modal-btn" class="absolute top-4 right-5 text-3xl font-bold cursor-pointer hover:text-red-500">&times;</span>
            <div id="knowledge-modal-body" class="text-white">
                <!-- Knowledge modal content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Resume Modal -->
    <div id="resume-modal" class="modal-base hidden">
        <div class="modal-content bg-slate-800 rounded-lg border border-slate-600 text-center">
            <h3 class="text-2xl font-bold mb-4">ì €ì¥ëœ ë‚´ìš© ë°œê²¬!</h3>
            <p class="mb-6 text-slate-300">ì´ì–´ì„œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-center gap-4">
                <button id="resume-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">ì´ì–´í•˜ê¸°</button>
                <button id="start-new-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">ìƒˆë¡œ ì‹œì‘</button>
            </div>
        </div>
    </div>


    <script>
    (function() {
        const appData = {
            roles: {
                scientist: {
                    name: 'ìš°ì£¼ê³¼í•™ì',
                    knowledge: [
                        "ë‹¬ì—ëŠ” ê³µê¸°(ì‚°ì†Œ)ê°€ ì „í˜€ ì—†ì–´ìš”", "ë‹¬ì—ì„œ ë¶ˆì€ íƒˆ ìˆ˜ ì—†ì–´ìš” (ì‚°ì†Œê°€ ì—†ìœ¼ë‹ˆê¹Œ)", "ë‚®ì—ëŠ” 120ë„, ë°¤ì—ëŠ” -170ë„ì˜ˆìš”", "ë‹¬ì—ëŠ” ìê¸°ì¥ì´ ì—†ì–´ì„œ ë°©ì‚¬ì„ ì´ ë§ì´ ë“¤ì–´ì™€ìš”", "ë‹¬ì—ì„œëŠ” ì¤‘ë ¥ì´ ì•½í•´ì„œ ë†’ì´ ë›¸ ìˆ˜ ìˆì–´ìš”", "ë¬¼ì€ ì§„ê³µ ìƒíƒœì—ì„œ ë“ì–´ìš”", "ìš°ì£¼ë³µì—ëŠ” ì´ë¯¸ ì˜¨ë„ ì¡°ì ˆ ê¸°ëŠ¥ì´ ìˆì–´ìš”", "ìš°ì£¼ë³µ ì•ˆì˜ ì‚°ì†ŒëŠ” ë³´í†µ 6-8ì‹œê°„ ì •ë„ ì“¸ ìˆ˜ ìˆì–´ìš”", "ìš°ì£¼ì¸ë“¤ì€ ë³´í†µ ê¸°ì €ê·€ë¥¼ ì…ê³  ìš°ì£¼ë³µì„ ì…ì–´ìš”", "ë‹¬ì˜ ì§€ë¦„ì€ 3,474kmì˜ˆìš”", "ë‹¬ì€ ì§€êµ¬ì—ì„œ 38ë§Œkm ë–¨ì–´ì ¸ ìˆì–´ìš”", "ë‹¬ì€ ì•½ 45ì–µë…„ ì „ì— ë§Œë“¤ì–´ì¡Œì–´ìš”", "ë‹¬ì—ëŠ” í† ë¼ê°€ ì‚´ê³  ìˆë‹¤ëŠ” ì „ì„¤ì´ ìˆì–´ìš”", "ë‹¬ì˜ ë°”ë‹¤ëŠ” ì‹¤ì œë¡œëŠ” ë¬¼ì´ ì—†ëŠ” í‰ì›ì´ì—ìš”", "ë‹¬ì—ëŠ” ì‚°ì†Œê°€ ì—†ë‹¤ëŠ” ì‚¬ì‹¤ì´ ì–´ë–¤ ë¬¼í’ˆì— ì˜í–¥ì„ ì¤„ê¹Œìš”?", "ê·¹í•œì˜ ì˜¨ë„ í™˜ê²½ì—ì„œ í•„ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?", "ìš°ì£¼ë³µì˜ ê¸°ëŠ¥ì„ ìƒê°í•˜ë©´ ì–´ë–¤ ë¬¼í’ˆì´ ì¤‘ë³µë ê¹Œìš”?"
                    ]
                },
                explorer: {
                    name: 'íƒí—˜ê°€',
                    knowledge: [
                        "ë‹¬ì—ëŠ” ì§€êµ¬ì²˜ëŸ¼ ìê¸°ì¥ì´ ì—†ì–´ì„œ ë‚˜ì¹¨ë°˜ì´ ì‘ë™ ì•ˆ í•´ìš”", "ë°¤í•˜ëŠ˜ì˜ ë³„ì„ ë³´ê³  ë°©í–¥ì„ ì°¾ì„ ìˆ˜ ìˆì–´ìš”", "ë‹¬ì—ì„œëŠ” ì†Œë¦¬ê°€ ë“¤ë¦¬ì§€ ì•Šì•„ìš” (ê³µê¸°ê°€ ì—†ì–´ì„œ)", "200kmëŠ” ì•„ì£¼ ë¨¼ ê±°ë¦¬ì˜ˆìš” (ì„œìš¸ì—ì„œ ëŒ€ì „ ì •ë„)", "ë†’ì€ ê³³ì—ì„œ ë–¨ì–´ì ¸ë„ ì²œì²œíˆ ë–¨ì–´ì ¸ìš”", "ëˆì´ë‚˜ ë¡œí”„ëŠ” ì—¬ëŸ¬ ìš©ë„ë¡œ ì“¸ ìˆ˜ ìˆì–´ìš”", "ê¸¸ì„ ìƒì—ˆì„ ë•ŒëŠ” í•œ ê³³ì— ë¨¸ë¬¼ëŸ¬ì•¼ í•œë‹¤ê³  ë°°ì› ì–´ìš”", "ì‘ê¸‰ìƒí™©ì—ì„œëŠ” ë°ì€ ìƒ‰ê¹” ì˜·ì´ ì¢‹ì•„ìš”", "ì•¼ì™¸ì—ì„œëŠ” í˜¸ë£¨ë¼ê¸°ë¡œ ë„ì›€ì„ ìš”ì²­í•´ìš”", "ì‚°ì—ì„œëŠ” í•´ê°€ ì§€ë©´ ê¸‰ê²©íˆ ì¶”ì›Œì ¸ìš”", "ì§€êµ¬ì—ì„œ ì‚°ì„ ì˜¤ë¥¼ ë•ŒëŠ” í•­ìƒ ë¬¼ì„ ë§ì´ ê°€ì ¸ê°€ìš”", "ë“±ì‚°í•  ë•ŒëŠ” ë”°ëœ»í•œ ì˜·ì„ ì…ì–´ì•¼ í•´ìš”", "ìˆ²ì—ì„œëŠ” ì´ë¼ê°€ ìˆëŠ” ìª½ì´ ë¶ìª½ì´ì—ìš”", "ìº í•‘í•  ë•ŒëŠ” í…íŠ¸ë¥¼ ë°”ëŒ ë°˜ëŒ€ìª½ì— ì³ì•¼ í•´ìš”", "ë‹¬ì—ì„œì˜ ê¸¸ì°¾ê¸°ëŠ” ì§€êµ¬ì™€ ì–´ë–»ê²Œ ë‹¤ë¥¼ê¹Œìš”?", "200kmë¼ëŠ” ê¸´ ê±°ë¦¬ë¥¼ ì´ë™í•˜ë ¤ë©´ ë¬´ì—‡ì´ í•„ìš”í• ê¹Œìš”?", "ì§€êµ¬ì—ì„œì˜ íƒí—˜ ìƒì‹ì´ ë‹¬ì—ì„œë„ í†µí• ê¹Œìš”?"
                    ]
                },
                communicator: {
                    name: 'í†µì‹ ì „ë¬¸ê°€',
                    knowledge: [
                        "íƒœì–‘ì—´ë¡œ ì¶©ì „ë˜ëŠ” ì¥ë¹„ëŠ” ë‚®ì—ë§Œ ì¶©ì „ë¼ìš”", "ë¬´ì „ê¸°ëŠ” ë°°í„°ë¦¬ê°€ ë–¨ì–´ì§€ë©´ ì“¸ ìˆ˜ ì—†ì–´ìš”", "ë‹¬ì—ì„œëŠ” ì „íŒŒê°€ ì§€êµ¬ë³´ë‹¤ ì˜ ì „ë‹¬ë¼ìš” (ë°©í•´ë¬¼ì´ ì—†ì–´ì„œ)", "ë°ì€ ì‹ í˜¸ëŠ” ë©€ë¦¬ì„œë„ ë³¼ ìˆ˜ ìˆì–´ìš”", "ì¡°ëª…íƒ„ì€ ì§„ê³µì—ì„œë„ íƒˆ ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ì¡Œì–´ìš”", "ì‘ê¸‰ì‹ í˜¸ëŠ” 3ë²ˆì”© ë°˜ë³µí•´ì•¼ í•´ìš”", "êµ¬ì¡°ëŒ€ê°€ ì˜¤ê³  ìˆëŠ”ì§€ëŠ” ëª¨ë¥´ê² ì–´ìš”", "ë³´íŠ¸ì—ëŠ” í’ì„ ì²˜ëŸ¼ ì••ì¶•ê°€ìŠ¤ê°€ ê°€ë“ ë“¤ì–´ ìˆì–´ìš”", "ê¸ˆì†ì€ ì „ê¸°ë¥¼ ì˜ í†µí•´ìš”", "íœ´ëŒ€í°ì€ ë³´í†µ í•˜ë£¨ ì •ë„ ë°°í„°ë¦¬ê°€ ì§€ì†ë¼ìš”", "WiFiëŠ” ë²½ì„ í†µê³¼í•˜ê¸° ì–´ë ¤ì›Œìš”", "ë¼ë””ì˜¤ëŠ” AMê³¼ FM ë‘ ì¢…ë¥˜ê°€ ìˆì–´ìš”", "ë¹„ê°€ ì˜¬ ë•ŒëŠ” ì „ìê¸°ê¸°ë¥¼ ì¡°ì‹¬í•´ì•¼ í•´ìš”", "ë¸”ë£¨íˆ¬ìŠ¤ëŠ” 10m ì •ë„ê¹Œì§€ ì—°ê²°ë¼ìš”", "ë‹¬ì—ì„œ êµ¬ì¡°ë°›ìœ¼ë ¤ë©´ ì–´ë–¤ ë°©ë²•ì´ ê°€ì¥ ì¢‹ì„ê¹Œìš”?", "ë°°í„°ë¦¬ì™€ ì „ë ¥ ê³µê¸‰ì€ ì–´ë–»ê²Œ í•´ê²°í• ê¹Œìš”?", "ì§€êµ¬ì—ì„œ ì“°ë˜ í†µì‹  ë°©ë²•ì´ ë‹¬ì—ì„œë„ í†µí• ê¹Œìš”?"
                    ]
                },
                medic: {
                    name: 'ì˜ë£Œì§„',
                    knowledge: [
                        "ìš°ì£¼ë³µì´ ì°¢ì–´ì§€ë©´ ë§¤ìš° ìœ„í—˜í•´ìš”", "ì‘ì€ ìƒì²˜ë„ ë‹¬ì—ì„œëŠ” ê°ì—¼ë  ìˆ˜ ìˆì–´ìš”", "ì´ì´ë‚˜ ì¡°ëª…íƒ„ì€ ë‹¤ì¹  ìœ„í—˜ì´ ìˆì–´ìš”", "ì‘ê¸‰ì²˜ì¹˜í•  ë•ŒëŠ” í™˜ìë¥¼ ë”°ëœ»í•˜ê²Œ í•´ì¤˜ì•¼ í•´ìš”", "ëª¸ì˜ ì²´ì˜¨ê³¼ ìˆ˜ë¶„ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”", "íƒˆìˆ˜ë˜ë©´ íŒë‹¨ë ¥ì´ ë–¨ì–´ì ¸ìš”", "ì˜ì–‘ ìƒíƒœê°€ ë‚˜ì˜ë©´ ì²´ë ¥ì´ ë–¨ì–´ì ¸ìš”", "ìŠ¤íŠ¸ë ˆìŠ¤ë°›ìœ¼ë©´ ì‹¤ìˆ˜ë¥¼ ë§ì´ í•´ìš”", "ë¶„ìœ ëŠ” ì˜ì–‘ê°€ê°€ ìˆì§€ë§Œ ë¬¼ì— íƒ€ì„œ ë¨¹ì–´ì•¼ í•´ìš”", "í•˜ë£¨ì— ë¬¼ì„ 8ì” ì •ë„ ë§ˆì…”ì•¼ ê±´ê°•í•´ìš”", "ê°ê¸°ì— ê±¸ë¦¬ë©´ ë”°ëœ»í•˜ê²Œ í•´ì•¼ í•´ìš”", "ìš´ë™ ì „ì—ëŠ” ìŠ¤íŠ¸ë ˆì¹­ì„ í•´ì•¼ í•´ìš”", "ì†ì„ ìì£¼ ì”»ì–´ì•¼ ì„¸ê· ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”", "ë¹„íƒ€ë¯¼CëŠ” ê°ê¸° ì˜ˆë°©ì— ì¢‹ì•„ìš”", "ë‹¬ì—ì„œ ê±´ê°•ì„ ì§€í‚¤ë ¤ë©´ ë¬´ì—‡ì´ ê°€ì¥ ì¤‘ìš”í• ê¹Œìš”?", "ì‘ê¸‰ìƒí™©ì´ ìƒê²¼ì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì²˜í•´ì•¼ í• ê¹Œìš”?", "ì§€êµ¬ì—ì„œì˜ ê±´ê°• ìƒì‹ì´ ë‹¬ì—ì„œë„ ì ìš©ë ê¹Œìš”?"
                    ]
                },
            },
            items: [
                { id: 1, name: 'ì‚°ì†Œí†µ 45kg (2ì •)', icon: 'ğŸ’¨', description: 'í˜¸í¡ì— í•„ìš”í•œ ì‚°ì†Œê°€ ì••ì¶•ë˜ì–´ ë“¤ì–´ìˆëŠ” ê¸ˆì† ìš©ê¸° 2ê°œì…ë‹ˆë‹¤.' },
                { id: 2, name: 'ë¬¼ (2L)', icon: 'ğŸ’§', description: 'ë§ˆì‹¤ ìˆ˜ ìˆëŠ” ê¹¨ë—í•œ ë¬¼ì´ ë‹´ê¸´ í†µì…ë‹ˆë‹¤.' },
                { id: 3, name: 'ë‹¬ì—ì„œ ë³¸ ë³„ìë¦¬ ì§€ë„', icon: 'ğŸ—ºï¸', description: 'ë‹¬ì˜ ë¶ë°˜êµ¬ì—ì„œ ë³´ì´ëŠ” ë³„ë“¤ì˜ ìœ„ì¹˜ë¥¼ í‘œì‹œí•œ ì²œì²´ ì§€ë„ì…ë‹ˆë‹¤.' },
                { id: 4, name: 'ìŒì‹ (ìš°ì£¼ì‹)', icon: 'ğŸ”', description: 'ë¬¼ ì—†ì´ ë°”ë¡œ ì„­ì·¨í•  ìˆ˜ ìˆë„ë¡ ë†ì¶•ëœ ë¹„ìƒ ì‹ëŸ‰ì…ë‹ˆë‹¤.' },
                { id: 5, name: 'íƒœì–‘ì—´ ì¶©ì „ì‹ FM ë¬´ì „ê¸°', icon: 'ğŸ“»', description: 'íƒœì–‘ ë¹›ìœ¼ë¡œ ì¶©ì „í•˜ì—¬ ë‹¨ê±°ë¦¬ ì£¼íŒŒìˆ˜ ë³€ì¡°(FM) ë°©ì‹ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 6, name: '15m ê¸¸ì´ì˜ ë‚˜ì¼ë¡  ëˆ', icon: 'ğŸ§¶', description: 'ê¸¸ê³  íŠ¼íŠ¼í•œ ë‚˜ì¼ë¡  ì†Œì¬ì˜ ëˆì…ë‹ˆë‹¤.' },
                { id: 7, name: 'êµ¬ê¸‰ ìƒì', icon: 'ğŸ©¹', description: 'ì†Œë…ì•½, ë¶•ëŒ€, ì˜ë£Œìš© í…Œì´í”„ ë“±ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
                { id: 8, name: 'ë‚™í•˜ì‚° ì²œ', icon: 'ğŸª‚', description: 'ê³µê¸° ì €í•­ì„ ì´ìš©í•˜ê¸° ìœ„í•œ í¬ê³  ì§ˆê¸´ ì²œì…ë‹ˆë‹¤.' },
                { id: 9, name: 'êµ¬ëª… ê³ ë¬´ë³´íŠ¸', icon: 'ğŸš¤', description: 'ë¬¼ ìœ„ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³ ë¬´ ì¬ì§ˆì˜ ë³´íŠ¸ì´ë©°, ì´ì‚°í™”íƒ„ì†Œ ê°€ìŠ¤í†µìœ¼ë¡œ ë¶€í’€ë¦½ë‹ˆë‹¤.' },
                { id: 10, name: 'ì‹ í˜¸ìš© ì¡°ëª…íƒ„', icon: 'ğŸ§¨', description: 'ë¨¼ ê³³ì— ì‹ í˜¸ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ ë°ì€ ë¹›ì„ ë‚´ë©° íƒ€ëŠ” í­ì£½ì…ë‹ˆë‹¤.' },
                { id: 11, name: '45êµ¬ê²½ ê¶Œì´', icon: 'ğŸ”«', description: 'ì´ì•Œì„ ë°œì‚¬í•˜ëŠ” ê°œì¸ìš© í™”ê¸°ì…ë‹ˆë‹¤.' },
                { id: 12, name: 'íœ´ëŒ€ìš© ë‚œë°©ê¸°', icon: 'ğŸ”¥', description: 'ì£¼ë³€ì„ ë”°ëœ»í•˜ê²Œ ë°ìš°ëŠ” íœ´ëŒ€ìš© ê¸°ê¸°ì…ë‹ˆë‹¤.' },
                { id: 13, name: 'ë¶„ìœ  í•œ ìƒì', icon: 'ğŸ¼', description: 'ì•„ê¸°ì—ê²Œ ì˜ì–‘ì„ ê³µê¸‰í•˜ê¸° ìœ„í•œ ë¶„ë§ í˜•íƒœì˜ ìš°ìœ ì…ë‹ˆë‹¤.' },
                { id: 14, name: 'ìì„ ë‚˜ì¹¨ë°˜', icon: 'ğŸ§­', description: 'ì§€êµ¬ì˜ ìê¸°ì¥ì„ ì´ìš©í•˜ì—¬ ë°©í–¥ì„ ê°€ë¦¬í‚¤ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.' },
                { id: 15, name: 'ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒì', icon: 'ğŸ“¦', description: 'ë§ˆì°°ì„ í†µí•´ ë¶ˆì„ ë¶™ì´ëŠ” ë„êµ¬ì¸ ì„±ëƒ¥ì´ ë“¤ì–´ìˆëŠ” ìƒìì…ë‹ˆë‹¤.' },
            ],
            state: {
                currentScreen: 'intro-screen',
                groupName: null,
                studentName: null,
                studentNumber: null,
                selectedRole: null,
            }
        };

        const dom = {
            appContainer: document.getElementById('app-container'),
            itemsPoolEl: document.getElementById('items-pool'),
            rankListEl: document.getElementById('rank-list'),
            modalEl: document.getElementById('item-modal'),
            modalBodyEl: document.getElementById('modal-body'),
            knowledgeModalEl: document.getElementById('knowledge-modal'),
            knowledgeModalBodyEl: document.getElementById('knowledge-modal-body'),
            resumeModalEl: document.getElementById('resume-modal'),
            groupNameInput: document.getElementById('groupNameInput'),
            studentNumberInput: document.getElementById('studentNumberInput'),
            studentNameInput: document.getElementById('studentNameInput'),
            roleTitle: document.getElementById('role-title'),
            knowledgeList: document.getElementById('knowledge-list'),
            finishButton: document.getElementById('finish-button'),
            finalGroupName: document.getElementById('final-group-name'),
            finalStudentNumber: document.getElementById('final-student-number'),
            finalStudentName: document.getElementById('final-student-name'),
            finalRole: document.getElementById('final-role'),
            finalList: document.getElementById('final-list'),
        };

        const SAVE_KEY = 'pinky-moon-survival-save';

        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active-screen'));
            document.getElementById(screenId).classList.add('active-screen');
            appData.state.currentScreen = screenId;
            saveState();
        };

        const startMission = () => {
            appData.state.groupName = dom.groupNameInput.value.trim();
            appData.state.studentName = dom.studentNameInput.value.trim();
            appData.state.studentNumber = dom.studentNumberInput.value;
            
            if (!appData.state.groupName || !appData.state.studentName || !appData.state.studentNumber) {
                alert('ëª¨ë‘ ëª…, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥(ì„ íƒ)í•´ì£¼ì„¸ìš”!');
                return;
            }
            showScreen('role-screen');
        };

        const selectRole = (roleId, changeScreen = true) => {
            appData.state.selectedRole = roleId;
            const role = appData.roles[roleId];
            dom.roleTitle.innerText = `[${role.name}]`;
            dom.knowledgeList.innerHTML = ''; 

            const roleKnowledgeTitle = document.createElement('h4');
            roleKnowledgeTitle.className = "text-lg font-bold text-orange-300 mt-4 md:col-span-2";
            roleKnowledgeTitle.textContent = "ğŸš€ ì „ë¬¸ ì§€ì‹";
            dom.knowledgeList.appendChild(roleKnowledgeTitle);

            role.knowledge.forEach(fact => {
                const li = document.createElement('div');
                li.className = "bg-slate-700 p-3 rounded";
                li.textContent = `- ${fact}`;
                dom.knowledgeList.appendChild(li);
            });

            const separator = document.createElement('hr');
            separator.className = "border-slate-600 my-4 md:col-span-2";
            dom.knowledgeList.appendChild(separator);

            const itemInfoTitle = document.createElement('h4');
            itemInfoTitle.className = "text-lg font-bold text-cyan-300 md:col-span-2";
            itemInfoTitle.textContent = "ğŸ’ ë¬¼í’ˆ ì •ë³´";
            dom.knowledgeList.appendChild(itemInfoTitle);

            appData.items.forEach(item => {
                const itemInfoEl = document.createElement('div');
                itemInfoEl.className = "bg-slate-700 p-3 rounded";
                itemInfoEl.innerHTML = `<p class="font-bold">${item.icon} ${item.name}</p><p class="text-sm text-slate-400 mt-1">${item.description}</p>`;
                dom.knowledgeList.appendChild(itemInfoEl);
            });

            if (changeScreen) {
                showScreen('knowledge-screen');
            }
        };
        
        const createPoolItemHTML = (item) => {
            return `
                <span class="drag-handle">â ¿</span>
                <span class="flex-1 min-w-0 pointer-events-none">${item.icon} ${item.name}</span>
                <button data-info-id="${item.id}" class="ml-auto text-xs bg-sky-600 hover:bg-sky-500 text-white py-1 px-2 rounded flex-shrink-0">ì •ë³´</button>
            `;
        };

        const initializeItems = () => {
            dom.itemsPoolEl.innerHTML = '';
            appData.items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.dataset.id = item.id;
                itemEl.className = 'item-card bg-slate-700 p-2 rounded-md flex items-center gap-2';
                itemEl.innerHTML = createPoolItemHTML(item);
                dom.itemsPoolEl.appendChild(itemEl);
            });
            checkFinishButton();
        };
        
        const openModal = (itemId) => {
            const item = appData.items.find(i => i.id === itemId);
            if (!item) return;
            dom.modalBodyEl.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">${item.icon} ${item.name}</h3>
                <p class="mb-4">${item.description}</p>
                <p class="text-sm text-slate-400">${(item.id === 9 || item.id === 11) ? 'ğŸ’¡ ì´ ë¬¼í’ˆì—ëŠ” ìˆ¨ê²¨ì§„ ê°€ì¹˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : ''}</p>
            `;
            dom.modalEl.classList.remove('hidden');
        };

        const closeModal = () => {
            dom.modalEl.classList.add('hidden');
        };
        
        const openKnowledgeModal = () => {
            if (!appData.state.selectedRole) return;
            const role = appData.roles[appData.state.selectedRole];
            dom.knowledgeModalBodyEl.innerHTML = '';

            const mainTitle = document.createElement('h3');
            mainTitle.className = "text-2xl font-bold mb-4 text-center";
            mainTitle.textContent = "ì •ë³´ ë‹¤ì‹œë³´ê¸°";
            dom.knowledgeModalBodyEl.appendChild(mainTitle);
            
            const scrollContainer = document.createElement('div');
            scrollContainer.className = "max-h-[60vh] overflow-y-auto p-2 space-y-4";
            
            const roleSection = document.createElement('div');
            const roleTitle = document.createElement('h4');
            roleTitle.className = "text-lg font-bold text-orange-300 mb-2";
            roleTitle.textContent = `ğŸš€ [${role.name}] ì „ë¬¸ ì§€ì‹`;
            roleSection.appendChild(roleTitle);

            const roleList = document.createElement('ul');
            roleList.className = "list-disc list-inside space-y-1 text-slate-300";
            role.knowledge.forEach(fact => {
                const li = document.createElement('li');
                li.textContent = fact;
                roleList.appendChild(li);
            });
            roleSection.appendChild(roleList);
            scrollContainer.appendChild(roleSection);

            const separator = document.createElement('hr');
            separator.className = "border-slate-600";
            scrollContainer.appendChild(separator);

            const itemSection = document.createElement('div');
            const itemTitle = document.createElement('h4');
            itemTitle.className = "text-lg font-bold text-cyan-300 mb-2";
            itemTitle.textContent = "ğŸ’ ë¬¼í’ˆ ì •ë³´";
            itemSection.appendChild(itemTitle);

            const itemListContainer = document.createElement('div');
            itemListContainer.className = "space-y-3";
            appData.items.forEach(item => {
                const itemInfoEl = document.createElement('div');
                itemInfoEl.className = "bg-slate-900 p-3 rounded";
                itemInfoEl.innerHTML = `<p class="font-bold">${item.icon} ${item.name}</p><p class="text-sm text-slate-400 mt-1">${item.description}</p>`;
                itemListContainer.appendChild(itemInfoEl);
            });
            itemSection.appendChild(itemTitle);
            scrollContainer.appendChild(itemSection);
            
            dom.knowledgeModalBodyEl.appendChild(scrollContainer);

            dom.knowledgeModalEl.classList.remove('hidden');
        };

        const closeKnowledgeModal = () => {
            dom.knowledgeModalEl.classList.add('hidden');
        };
        
        const renderRankedItemContent = (itemId, index) => {
            const item = appData.items.find(i => i.id == itemId);
            return `
                <div class="flex items-center gap-2 mb-2">
                    <span class="drag-handle">â ¿</span>
                    <div class="flex-1 min-w-0 font-bold text-lg text-orange-400 flex items-center pointer-events-none">
                        <span class="rank-number mr-2">${index + 1}ìœ„.</span>
                        <span>${item.icon} ${item.name}</span>
                    </div>
                    <button data-info-id="${item.id}" class="text-xs bg-sky-600 hover:bg-sky-500 text-white py-1 px-2 rounded ml-auto">ì •ë³´</button>
                </div>
                <textarea data-reason-id="${item.id}" class="w-full bg-slate-900 text-white rounded p-2 text-sm" rows="2" placeholder="ì´ ë¬¼í’ˆì„ ì´ ìˆœìœ„ë¡œ ì •í•œ ì´ìœ ëŠ”..."></textarea>
            `;
        };
        
        const updateRankNumbers = () => {
            const rankedItems = dom.rankListEl.querySelectorAll('.ranked-item');
            rankedItems.forEach((item, index) => {
                const rankNumberEl = item.querySelector('.rank-number');
                if (rankNumberEl) {
                    rankNumberEl.textContent = `${index + 1}ìœ„.`;
                }
            });
            checkFinishButton();
        };

        const checkFinishButton = () => {
            const itemCount = dom.rankListEl.querySelectorAll('.ranked-item').length;
            dom.finishButton.disabled = (itemCount !== 15);
        };
        
        const generateReport = () => {
            dom.finalGroupName.textContent = appData.state.groupName;
            dom.finalStudentName.textContent = appData.state.studentName;
            dom.finalStudentNumber.textContent = appData.state.studentNumber;
            dom.finalRole.textContent = appData.roles[appData.state.selectedRole].name;
            dom.finalList.innerHTML = '';
            
            const rankedElements = Array.from(dom.rankListEl.querySelectorAll('.ranked-item'));

            rankedElements.forEach((el, index) => {
                const itemId = el.dataset.id;
                const item = appData.items.find(i => i.id == itemId);
                const reason = el.querySelector(`textarea[data-reason-id="${itemId}"]`).value;

                const reportItem = document.createElement('div');
                reportItem.className = 'p-3 bg-slate-900 rounded-md';
                reportItem.innerHTML = `
                    <p class="font-bold text-lg">${index + 1}ìœ„. ${item.icon} ${item.name}</p>
                    <p class="text-sm text-slate-300 pl-4 mt-1">ì´ìœ : ${reason || 'ì‘ì„±í•˜ì§€ ì•ŠìŒ'}</p>
                `;
                dom.finalList.appendChild(reportItem);
            });

            showScreen('report-screen');
        };
        
        const downloadReport = () => {
            const reportContent = document.getElementById('report-content');
            const groupName = appData.state.groupName || 'ëª¨ë‘ ì—†ìŒ';
            const studentNumber = appData.state.studentNumber || '00';
            const studentName = appData.state.studentName || 'ì´ë¦„ì—†ìŒ';
            const fileName = `í•‘í‚¤ë„¤í”„ë¡œì íŠ¸001_${groupName}_${studentNumber}ë²ˆ${studentName}.png`;

            html2canvas(reportContent, { 
                backgroundColor: "#172a46",
                onclone: (doc) => {
                     doc.getElementById('report-content').style.color = '#e6f1ff';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        };
        
        const restart = (fromButton = false) => {
            if (fromButton && !confirm('ì •ë§ ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì‚­ì œí•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            localStorage.removeItem(SAVE_KEY);
            window.location.reload();
        };
        
        const populateStudentNumbers = () => {
            dom.studentNumberInput.innerHTML = '<option value="">-- ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>';
            for (let i = 1; i <= 40; i++) {
                const numberString = String(i).padStart(2, '0');
                const option = document.createElement('option');
                option.value = numberString;
                option.textContent = numberString;
                dom.studentNumberInput.appendChild(option);
            }
        };

        const saveState = () => {
            try {
                const rankedItemIds = Array.from(dom.rankListEl.querySelectorAll('.ranked-item')).map(el => parseInt(el.dataset.id, 10));
                const poolItemIds = Array.from(dom.itemsPoolEl.querySelectorAll('.item-card')).map(el => parseInt(el.dataset.id, 10));
                const reasons = {};
                dom.rankListEl.querySelectorAll('textarea[data-reason-id]').forEach(textarea => {
                    reasons[textarea.dataset.reasonId] = textarea.value;
                });

                const stateToSave = { ...appData.state, rankedItemIds, poolItemIds, reasons };
                localStorage.setItem(SAVE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
            }
        };

        const restoreSession = () => {
            try {
                const savedStateJSON = localStorage.getItem(SAVE_KEY);
                if (!savedStateJSON) return;
                const savedState = JSON.parse(savedStateJSON);

                appData.state = { ...appData.state, ...savedState };

                dom.groupNameInput.value = savedState.groupName || '';
                dom.studentNumberInput.value = savedState.studentNumber || '';
                dom.studentNameInput.value = savedState.studentName || '';

                dom.itemsPoolEl.innerHTML = '';
                dom.rankListEl.innerHTML = '';

                const poolItemIds = new Set(savedState.poolItemIds || appData.items.map(i => i.id));
                const rankedItemIds = savedState.rankedItemIds || [];

                rankedItemIds.forEach((itemId, index) => {
                    const item = appData.items.find(i => i.id === itemId);
                    if (item) {
                        const itemEl = document.createElement('div');
                        itemEl.dataset.id = item.id;
                        itemEl.className = 'ranked-item bg-slate-700 p-3 rounded-md';
                        itemEl.innerHTML = renderRankedItemContent(item.id, index);
                        dom.rankListEl.appendChild(itemEl);
                        if (savedState.reasons && savedState.reasons[itemId]) {
                            itemEl.querySelector('textarea').value = savedState.reasons[itemId];
                        }
                    }
                    poolItemIds.delete(itemId);
                });
                
                poolItemIds.forEach(itemId => {
                    const item = appData.items.find(i => i.id === itemId);
                    if(item) {
                        const itemEl = document.createElement('div');
                        itemEl.dataset.id = item.id;
                        itemEl.className = 'item-card bg-slate-700 p-2 rounded-md flex items-center gap-2';
                        itemEl.innerHTML = createPoolItemHTML(item);
                        dom.itemsPoolEl.appendChild(itemEl);
                    }
                });
                
                if(savedState.selectedRole) {
                    selectRole(savedState.selectedRole, false);
                }
                
                showScreen(savedState.currentScreen || 'intro-screen');
                updateRankNumbers();
            } catch (e) {
                console.error("ë³µì› ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                localStorage.removeItem(SAVE_KEY);
            }
        };

        // --- Event Listeners and Initializers ---

        new Sortable(dom.itemsPoolEl, {
            group: 'shared',
            handle: '.drag-handle',
            animation: 150,
            onAdd: (evt) => {
                const itemEl = evt.item;
                const itemId = parseInt(itemEl.dataset.id, 10);
                const item = appData.items.find(i => i.id === itemId);
                if (item) {
                    itemEl.className = 'item-card bg-slate-700 p-2 rounded-md flex items-center gap-2';
                    itemEl.innerHTML = createPoolItemHTML(item);
                }
                saveState();
            },
        });

        new Sortable(dom.rankListEl, {
            group: 'shared',
            handle: '.drag-handle',
            animation: 150,
            onAdd: (evt) => {
                const itemEl = evt.item;
                const itemId = parseInt(itemEl.dataset.id, 10);
                itemEl.className = 'ranked-item bg-slate-700 p-3 rounded-md';
                itemEl.innerHTML = renderRankedItemContent(itemId, evt.newDraggableIndex);
                updateRankNumbers();
                saveState();
            },
            onUpdate: () => {
                updateRankNumbers();
                saveState();
            }
        });

        document.addEventListener('click', (event) => {
            const target = event.target;
            const roleCard = target.closest('.role-card');
            const infoButton = target.closest('button[data-info-id]');

            if (target.id === 'start-mission-btn') startMission();
            else if (roleCard) selectRole(roleCard.dataset.role);
            else if (target.id === 'go-to-ranking-btn') showScreen('main-screen');
            else if (target.id === 'open-knowledge-modal-btn') openKnowledgeModal();
            else if (target.id === 'finish-button') generateReport();
            else if (target.id === 'download-report-btn') downloadReport();
            else if (target.id === 'restart-btn') restart(true);
            else if (target.id === 'close-item-modal-btn') closeModal();
            else if (target.id === 'close-knowledge-modal-btn') closeKnowledgeModal();
            else if (infoButton) {
                event.stopPropagation();
                const itemId = parseInt(infoButton.dataset.infoId, 10);
                openModal(itemId);
            }
        });

        dom.rankListEl.addEventListener('input', (event) => {
            if (event.target.tagName === 'TEXTAREA') {
                saveState();
            }
        });

        window.onclick = (event) => {
            if (event.target == dom.modalEl) closeModal();
            if (event.target == dom.knowledgeModalEl) closeKnowledgeModal();
        };
        
        window.addEventListener('load', () => {
            populateStudentNumbers();
            initializeItems();
            const savedStateJSON = localStorage.getItem(SAVE_KEY);
            if (savedStateJSON) {
                const resumeBtn = document.getElementById('resume-btn');
                const startNewBtn = document.getElementById('start-new-btn');
                if (resumeBtn && startNewBtn) {
                    dom.resumeModalEl.classList.remove('hidden');
                    resumeBtn.onclick = () => {
                        restoreSession();
                        dom.resumeModalEl.classList.add('hidden');
                    };
                    startNewBtn.onclick = () => {
                        restart(false);
                    };
                }
            }
        });
    })();
    </script>
</body>
</html>
